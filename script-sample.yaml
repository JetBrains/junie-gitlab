stages:
  - junie

# =============================================================================
# Junie Trigger Configuration
# =============================================================================
# IMPORTANT: If you change the bot name from "junie" to something else,
# you must update TWO places to keep them in sync:
#
# 1. junie-run rules: $COMMENT_TEXT =~ /@YOUR_BOT_NAME(\s|$)/i
#    This filters comments BEFORE starting the pipeline (saves CI resources)
#
# 2. junie-run variables: JUNIE_BOT_TAGGING_PATTERN: "YOUR_BOT_NAME[-a-zA-Z0-9]*"
#    This is used inside the wrapper code to detect mentions
#
# =============================================================================

junie-init:
  stage: junie
  image: registry.jetbrains.team/p/matterhorn/public/junie-gitlab-wrapper:latest
  script:
    - node /app/dist/cli.js init --verbose
  when: manual
  rules:
    - if: $CI_PIPELINE_SOURCE == "api"
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - .gitlab-ci.yml
      when: manual

junie-run:
  stage: junie
  image: registry.jetbrains.team/p/matterhorn/public/junie-gitlab-wrapper:latest
  script:
    - node /app/dist/cli.js run --cleanup --verbose
  after_script:
    - mkdir -p junie-artifacts/working-directory
    - mkdir -p junie-artifacts/logs
    - mkdir -p junie-artifacts/sessions
    - cp -R /junieCache/. ./junie-artifacts/working-directory/ 2>/dev/null || true
    - cp -R ~/.junie/logs/. ./junie-artifacts/logs/ 2>/dev/null || true
    - cp -R ~/.junie/sessions/. ./junie-artifacts/sessions/ 2>/dev/null || true
  rules:
    # Only run for comment events that mention @junie (case insensitive)
    # This prevents creating pipelines for every comment
    # NOTE: Keep this regex in sync with JUNIE_MENTION_TRIGGER variable above
    - if: $CI_PIPELINE_SOURCE == "api" && $EVENT_KIND == "note" && $COMMENT_TEXT =~ /@junie(\s|$)/i
      when: always
    - when: never
  variables:
    # Pattern for matching Junie bot mentions inside the wrapper code
    # NOTE: Keep this in sync with JUNIE_MENTION_TRIGGER and the regex in rules above
    JUNIE_BOT_TAGGING_PATTERN: "junie[-a-zA-Z0-9]*"
  artifacts:
    paths:
      - junie-artifacts/working-directory
      - junie-artifacts/logs
      - junie-artifacts/sessions
    expire_in: 1 week
    when: always

# Optional: Automatic code review on every MR update
# Uncomment this job to enable automatic code review
junie-auto-code-review:
  stage: junie
  image: registry.jetbrains.team/p/matterhorn/public/junie-gitlab-wrapper:latest
  script:
    - node /app/dist/cli.js run --prompt "code-review" --verbose
  after_script:
    - mkdir -p junie-artifacts/working-directory
    - mkdir -p junie-artifacts/logs
    - mkdir -p junie-artifacts/sessions
    - cp -R /junieCache/. ./junie-artifacts/working-directory/ 2>/dev/null || true
    - cp -R ~/.junie/logs/. ./junie-artifacts/logs/ 2>/dev/null || true
    - cp -R ~/.junie/sessions/. ./junie-artifacts/sessions/ 2>/dev/null || true
  rules:
    # Only run for MR events, skip on close or merge
    - if: $CI_PIPELINE_SOURCE == "api" && $EVENT_KIND == "merge_request" && $MR_EVENT_ACTION != "close" && $MR_EVENT_ACTION != "merge"
      when: always
    - when: never
  variables:
   USE_MCP: "true"
   JUNIE_MODEL: "claude-sonnet-4-5-20250929"  # Use Claude instead of Gemini for MCP compatibility
  artifacts:
    paths:
      - junie-artifacts/working-directory
      - junie-artifacts/logs
      - junie-artifacts/sessions
    expire_in: 1 week
    when: always

# Optional: Additional custom job with different prompt
# junie-security-check:
#   stage: junie
#   image: registry.jetbrains.team/p/matterhorn/public/junie-gitlab-wrapper:latest
#   script:
#     - node /app/dist/cli.js run --prompt "Check for security vulnerabilities in the changes" --verbose
#   after_script:
#     - mkdir -p junie-artifacts/working-directory
#     - mkdir -p junie-artifacts/logs
#     - mkdir -p junie-artifacts/sessions
#     - cp -R /junieCache/. ./junie-artifacts/working-directory/ 2>/dev/null || true
#     - cp -R ~/.junie/logs/. ./junie-artifacts/logs/ 2>/dev/null || true
#     - cp -R ~/.junie/sessions/. ./junie-artifacts/sessions/ 2>/dev/null || true
#   rules:
#     # Only run when MR is opened (not on updates)
#     - if: $CI_PIPELINE_SOURCE == "api" && $EVENT_KIND == "merge_request" && $MR_EVENT_ACTION == "open"
#       when: always
#     - when: never
#   variables:
#     USE_MCP: "true"
#   artifacts:
#     paths:
#       - junie-artifacts/working-directory
#       - junie-artifacts/logs
#       - junie-artifacts/sessions
#     expire_in: 1 week
#     when: always

